version: 2.1

orbs:
  aws-cli: circleci/aws-cli@5


parameters:
  delete-services:
    description: If true, deletes the Terraform resources in AWS.
    type: boolean
    default: false


workflows:
  build-deploy:
    when:
      not: << pipeline.parameters.delete-services >>
    jobs:
      - check-format-backend-files
      - lint-typescript-code
      - build-backend:
          requires:
            - check-format-backend-files
            - lint-typescript-code
      - check-format-terraform-code
      - lint-terraform-code
      - deploy-backend-and-infrastructure:
          requires:
            - build-backend
            - check-format-terraform-code
            - lint-terraform-code
      - build-frontend:
          requires:
            - deploy-backend-and-infrastructure
      - deploy-frontend:
          requires:
            - build-frontend

  delete-services:
    when: << pipeline.parameters.delete-services >>
    jobs:
      - terraform-destroy


jobs:
  check-format-backend-files:
    docker:
      - image: cimg/node:22.10
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            cd backend
            npm install
      - run:
          name: Check file formatting
          command: |
            cd backend
            npm run check-format

  lint-typescript-code:
    docker:
      - image: cimg/node:22.10
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            cd backend
            npm install
      - run:
          name: Lint TypeScript code
          command: |
            cd backend
            npm run lint

  build-backend:
    docker:
      - image: cimg/node:22.10
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            cd backend
            npm install
      - run:
          name: Compile code
          command: |
            cd backend
            npm run build
      - run:
          name: Build Lambda Layer
          command: |
            # https://docs.aws.amazon.com/lambda/latest/dg/nodejs-layers.html
            mkdir --parent backend/build/lambda-layer/nodejs
            cd backend/src/lambda-layer
            npm install
            cp --verbose --recursive node_modules ../../build/lambda-layer/nodejs
      - persist_to_workspace:
          root: backend/build
          paths:
            - ./*

  check-format-terraform-code:
    docker:
      - image: hashicorp/terraform:1.9
    steps:
      - checkout
      - run:
          name: Install make
          command: apk add make
      - run:
          name: Check format of Terraform code
          command: make check-format-terraform

  lint-terraform-code:
    docker:
      - image: cimg/base:2024.10
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
            make lint-init-terraform
      - run:
          name: Lint Terraform code
          command: make lint-terraform

  build-frontend:
    docker:
      - image: cimg/node:22.10
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            cd frontend
            npm install
      - run:
          name: build frontend
          command: |
            cd frontend
            npm run build
            mv out build
      - persist_to_workspace:
          root: frontend/build
          paths:
            - ./*

  deploy-frontend:
    docker:
      - image: cimg/node:22.10
    steps:
      - checkout
      - attach_workspace:
          at: frontend/build
      - aws-cli/setup:
          role_arn: "$AWS_ROLE_ARN"
      - run:
          name: deploy frontend
          command: |
            cd frontend
            aws s3 sync build s3://pnp-character-application-frontend --region eu-central-1

  # https://developer.hashicorp.com/terraform/tutorials/automation/circle-ci
  deploy-backend-and-infrastructure:
    docker:
      - image: hashicorp/terraform:1.9
    steps:
      - checkout
      - attach_workspace:
          at: backend/build
      - aws-cli/setup:
          role_arn: "$AWS_ROLE_ARN"
      - run:
          name: Terraform init
          command: |
            cd terraform
            terraform init -input=false
      - run:
          name: Terraform plan
          command: |
            cd terraform
            terraform plan -out tfapply
      - run:
          name: Terraform apply
          command: |
            cd terraform
            terraform apply -auto-approve tfapply

  terraform-destroy:
    docker:
      - image: hashicorp/terraform:1.9
    steps:
      - checkout
      - aws-cli/setup:
          role_arn: "$AWS_ROLE_ARN"
      - run:
          name: Terraform init
          command: |
            cd terraform
            terraform init -input=false
      - run:
          name: Terraform plan destroy
          command: |
            cd terraform
            terraform plan -destroy -out tfdestroy
      - run:
          name: Terraform destroy
          command: |
            cd terraform
            terraform apply -auto-approve tfdestroy
